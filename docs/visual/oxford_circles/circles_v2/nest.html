<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <title>Pack layout</title>
</head>

<style>
circle {
  fill: #333;
  /*opacity: 0.3;*/
  stroke: white;
}
</style>
<link rel="stylesheet" href="style.css">

<body>

  School-Teacher: <select id="schoolID">
    <option value="" selected="selected">All</option>
  </select>

  <input type="checkbox" class="valFilter" value="LC" checked> LC
  <input type="checkbox" class="valFilter" value="DLS" checked> DLS
  <input type="checkbox" class="valFilter" value="BA" checked> BA
  <input type="checkbox" class="valFilter" value="FS" checked> FS
  <!-- <input type="checkbox" class="valFilter" value="gender"> Gender -->
  <input type="button" value="Redraw" onclick="filter_plot();" /><br>


  <svg width="1024" height="768">
    <g></g>
  </svg>

  <script src="d3.v4.min.js"></script>
  <script>


var duration_fade = 500;


// Read a page's GET URL variables and return them as an associative array.
function getUrlVars()
{
    var vars = [], hash;
    var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
    for(var i = 0; i < hashes.length; i++)
    {
        hash = hashes[i].split('=');
        vars.push(hash[0]);
        vars[hash[0]] = hash[1];
    }
    return vars;
}

var a = getUrlVars()
var dataset = "all_data.csv"
if (a.dataset !== undefined){
  console.log("Dataset param: " + a.dataset);
  dataset = a.dataset
}

var risk_cols = ["#49E83E", "#FFD432", "#E84B30"]
var risk_text = ["Green", "Ambar", "Red"]
// var radius_multiplier = [[1], [1,0.5], [1,0.7,0.33], [1,0.77,0.55,0.3]]
var radius_multiplier = [[1], [0.5,1], [0.33,0.7,1], [0.3, 0.55, 0.77,1]]


function filter_plot() {
  var choices = [];
  console.log("SchoolID: " + d3.select("#schoolID").value);
  d3.selectAll(".valFilter").each(function(d){
    cb = d3.select(this);
    if(cb.property("checked")){
      choices.push(cb.property("value"));
    }
  });
  // console.log(choices);
  // console.log(dataset);

  var school_filter = d3.select("#schoolID").node().value;
  var is_school = school_filter != "";
  d3.csv(dataset, function(data) {
    // console.log(data)
    var entries_nest = d3.nest()
    // .key(function(d) { return d.School; })
    .key(function(d) { return JSON.stringify([
                choices.includes("LC") ? d.LC : "-",
                choices.includes("DLS") ? d.DLS : "-",
                choices.includes("BA") ? d.BA : "-",
                choices.includes("FS") ? d.FS : "-"
                ]); })
    .rollup(function(d) { return {count: d.length,
                BA: d3.mean(d, function(v) { return v.BA; }),
                LC: d3.mean(d, function(v) { return v.LC; }),
                DLS: d3.mean(d, function(v) { return v.DLS; }),
                FS: d3.mean(d, function(v) { return v.FS; }),
                gender: d3.mean(d, function(v) { return v.gender; }),
                ethnic: d3.mean(d, function(v) { return v.ethnic; })
              }; })
    .entries(is_school ? data.filter(function(c) {return c.School == school_filter}) : data);
    // console.log(entries_nest);

    var school_ids = d3.nest()
    // .key(function(d) { return d.data.row_name; })
    .key(function(d) { return d.School; })
    .rollup(function(d) { return d[0]["School"] + " (" +  d.length + " students)";})
    .entries(data);

    // console.log(school_ids);
    var select = d3.select('#schoolID');
    var options = select
      .selectAll('option')
      .data(school_ids).enter()
        .append('option')
        .attr("value", function (d) { return d.key; })
        .text(function (d) { return d.value; });

// 70-37
    // console.log(choices.length);
    d3.select('svg g').selectAll('g').transition().duration(duration_fade).style("opacity", 1e-6).remove();
    d3.transition()
      .duration(duration_fade)
      .on("end", function bla() {
        updateGraph({"name": "A1", "value": {"count": 0, "dimensions": choices, "n": choices.length} ,"children": entries_nest});
        // updateGraph({"name": "A1", "value": {"count": 0, "dimensions": choices, "n": choices.length} ,"children": entries_nest[0].values});
        // console.log("End transtion");
      });
  });
}






function updateGraph(data) {
  console.log(data);

  var packLayout = d3.pack()
    .size([1024, 768]);

  var rootNode = d3.hierarchy(data)

  rootNode.sum(function(d) {
    // console.log(d.key + " " + d.value.count)
    return d.value.count;
    // return d.value["count"];
  });
  // console.log(rootNode)
  var n = rootNode.data.value.n;
  var dimensions = rootNode.data.value.dimensions;

  packLayout(rootNode);

  var tooltip = d3.select("body")
    .append("div")
    .attr("class", "tooltip")
    .style("position", "absolute")
    .style("z-index", "10")
    .style("visibility", "hidden")
    .text("a simple tooltip");

  // d3.select('svg g').selectAll('g').transition().duration(duration_fade).style("opacity", 1e-6).remove();

  var nodes = d3.select('svg g')
    .selectAll('g')
    .data(rootNode.descendants())
    .enter()
    .append('g')
    .attr('transform', function(d) {return 'translate(' + [d.x, d.y] + ')'})

  var i;
  for (i = n-1; i >= 0; i--) {
    console.log( radius_multiplier[n-1][i] + " " + dimensions[i])
    nodes
      .append('circle')
        .attr('r', function(d) { return d.r * radius_multiplier[n-1][i]; })
        .attr('class', function(d) { return d.children === undefined ? "inner" : "outer"; })
        // .style("fill", function(d) { return risk_cols[d.data.value.BA]; })
        .style("fill", function(d) { return risk_cols[d.data.value[dimensions[i]]]; })
        .style("opacity", 0)
        .transition().duration(duration_fade).style("opacity", function (d) { return d.children === undefined ? 1 : 0; }); // set the
  }

  // nodes.transition().duration(duration_fade).style("opacity", function (d) { return d.children === undefined ? 1 : 0; }); // set the stroke opacity

  nodes
    .append('text')
    .attr("text-anchor", "middle")
    .attr("dy", ".35em")
    .style("opacity", 1)
    .text(function(d) {
      return d.children === undefined ? d.data.value.count : '';
    })

  nodes.selectAll(".inner")
    // .attr("cx", function (d) { return 1.3 * d.n + 25; })
    // .attr("cy", function (d) { return 1.3 * d.n - 80; })
    .style("stroke", "black")    // set the line colour
    .style("stroke-opacity", .2) // set the stroke opacity
    .on("mouseover", function(d){return d.children === undefined ? tooltip.style("visibility", "visible").html(
              "N: " + d.value +
              (!dimensions.includes("LC") ? "": "<br> Language and Cognition: " + risk_text[d.data.value.LC]) +
              (!dimensions.includes("DLS") ? "": "<br> Daily Living Skills: " + risk_text[d.data.value.DLS]) +
              (!dimensions.includes("BA") ? "": "<br> Behavioral Adjustment: " + risk_text[d.data.value.BA]) +
              (!dimensions.includes("FS") ? "": "<br> Family Support: " + risk_text[d.data.value.FS])): 0;})
    .on("mousemove", function(){return tooltip.style("top",
        (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");})
    .on("mouseout", function(){return tooltip.style("visibility", "hidden");});
}
filter_plot();
  </script>
</body>
</html>
